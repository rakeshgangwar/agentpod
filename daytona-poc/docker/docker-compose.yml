# Daytona POC - Minimal Self-Hosted Setup
# Based on https://github.com/daytonaio/daytona/blob/main/docker/docker-compose.yaml
# 
# NOTE: This setup is still in development and NOT production-safe
# See: https://github.com/daytonaio/daytona/tree/main/docker

name: daytona-poc

services:
  # =============================================================================
  # Core Daytona Services
  # =============================================================================
  
  api:
    image: daytonaio/daytona-api
    ports:
      - 3000:3000
    environment:
      # Use the official slim image for faster startup (pulled from Docker Hub)
      - DEFAULT_SNAPSHOT=daytonaio/sandbox:0.5.0-slim
      # Disable OTEL since we don't have those services
      - OTEL_ENABLED=false
      # Accept runners with 0 availability score (needed for DinD where cgroup metrics fail)
      - RUNNER_AVAILABILITY_SCORE_THRESHOLD=0
      - RUNNER_DECLARATIVE_BUILD_SCORE_THRESHOLD=0
    networks:
      - daytona-network
    restart: unless-stopped
    privileged: true
    depends_on:
      db:
        condition: service_started
      runner:
        condition: service_started
      redis:
        condition: service_started
      dex:
        condition: service_healthy
      registry:
        condition: service_started

  proxy:
    image: daytonaio/daytona-proxy
    networks:
      - daytona-network
    ports:
      - 4000:4000
    restart: unless-stopped

  runner:
    image: daytonaio/daytona-runner
    networks:
      - daytona-network
    ports:
      - 3013:3003  # Host port 3013 -> container port 3003 (avoid conflict)
    privileged: true
    restart: unless-stopped
    # Use host cgroup namespace to allow proper cgroup management
    cgroup: host
    # Mount cgroups for proper resource detection
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    environment:
      # Provide static resource values to work around DinD metrics detection issues
      - RUNNER_CPU_CORES=4
      - RUNNER_MEMORY_GB=8
      - RUNNER_DISK_GB=50

  ssh-gateway:
    image: daytonaio/daytona-ssh-gateway
    networks:
      - daytona-network
    ports:
      - 2222:2222
    restart: unless-stopped

  # =============================================================================
  # Infrastructure Services
  # =============================================================================

  dex:
    image: dexidp/dex:v2.42.0
    volumes:
      - ./dex/config.yaml:/etc/dex/config.yaml
      - dex_db:/var/dex
    entrypoint: ['sh', '-c', 'touch /var/dex/dex.db && exec dex serve /etc/dex/config.yaml']
    networks:
      - daytona-network
    ports:
      - 5556:5556
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:5556/dex/.well-known/openid-configuration"]
      interval: 5s
      timeout: 5s
      retries: 5

  db:
    image: postgres:18
    environment:
      - POSTGRES_PASSWORD=pass
      - POSTGRES_USER=user
      - POSTGRES_DB=daytona
    networks:
      - daytona-network
    volumes:
      - db_data:/var/lib/postgresql/18/docker
    restart: unless-stopped

  redis:
    image: redis:latest
    networks:
      - daytona-network
    restart: unless-stopped

  # Docker registry for custom images (our OpenCode sandbox image)
  registry:
    image: registry:2.8.2
    environment:
      REGISTRY_HTTP_ADDR: registry:6000
      REGISTRY_STORAGE_DELETE_ENABLED: 'true'
    volumes:
      - registry_data:/var/lib/registry
    networks:
      - daytona-network
    ports:
      - 6000:6000
    restart: unless-stopped

  # MinIO for S3-compatible object storage (snapshots, etc.)
  minio:
    image: minio/minio:latest
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
      - MINIO_IDENTITY_STS_EXPIRY=24h
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - daytona-network
    ports:
      - 9001:9001
    restart: unless-stopped

volumes:
  registry_data: {}
  minio_data: {}
  db_data: {}
  dex_db: {}

networks:
  daytona-network:
    driver: bridge
