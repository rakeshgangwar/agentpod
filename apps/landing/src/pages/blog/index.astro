---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

const allPosts = await getCollection("blog");
const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

function calculateReadTime(content: string): number {
  const wordsPerMinute = 200;
  const words = content.trim().split(/\s+/).length;
  return Math.ceil(words / wordsPerMinute);
}

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
}
---

<BaseLayout title="Blog — AgentPod" description="Thoughts on portable AI sandboxes, development tools, and building in public">
  <Header slot="header" />
  
  <!-- Blog Header -->
  <section class="pt-20 pb-12 px-4">
    <div class="max-w-4xl mx-auto">
      <div class="terminal-window animate-fade-in-up">
        <div class="terminal-header">
          <div class="terminal-dot bg-red-500"></div>
          <div class="terminal-dot bg-yellow-500"></div>
          <div class="terminal-dot bg-green-500"></div>
          <span class="ml-4 text-xs text-muted-foreground font-mono">blog.archive</span>
        </div>
        <div class="terminal-body">
          <div class="text-cyber-cyan font-mono text-sm mb-2">$ cat /blog</div>
          <div class="text-muted-foreground text-sm">
            Thoughts on portable AI sandboxes, development patterns, and building in public.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Blog Posts Grid -->
  <section class="pb-20 px-4">
    <div class="max-w-4xl mx-auto">
      <div class="space-y-6">
        {sortedPosts.map((post, index) => {
          const readTime = calculateReadTime(post.body);
          const formattedDate = formatDate(post.data.date);
          
          return (
            <article 
              class={`terminal-window blog-card animate-fade-in-up stagger-${Math.min(index + 1, 6)}`}
            >
              <div class="terminal-header">
                <span class="text-xs text-muted-foreground font-mono">
                  {formattedDate}
                </span>
                <span class="ml-auto flex items-center gap-2">
                  <span class="text-xs text-cyber-cyan">{readTime} min read</span>
                  {post.data.tags.slice(0, 2).map((tag: string) => (
                    <span class="text-xs px-2 py-0.5 bg-cyber-cyan/10 text-cyber-cyan rounded">
                      #{tag}
                    </span>
                  ))}
                </span>
              </div>
              <div class="terminal-body">
                <a href={`/blog/${post.id}`} class="group block">
                  <h2 class="text-xl font-bold text-foreground mb-3 group-hover:text-cyber-cyan transition-colors">
                    {post.data.title}
                  </h2>
                  <p class="text-muted-foreground text-sm mb-4 leading-relaxed">
                    {post.data.excerpt}
                  </p>
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-xs text-muted-foreground">
                      <span class="text-cyber-emerald">▸</span>
                      <span>by {post.data.author}</span>
                    </div>
                    <div class="cyber-btn text-xs group-hover:bg-cyber-cyan group-hover:text-background transition-all">
                      $ read --post
                    </div>
                  </div>
                </a>
              </div>
            </article>
          );
        })}
      </div>

      <!-- Empty State (if no posts) -->
      {sortedPosts.length === 0 && (
        <div class="terminal-window text-center py-12">
          <div class="terminal-body">
            <div class="text-muted-foreground text-sm font-mono">
              <div class="text-cyber-amber mb-2">$ ls -la /blog</div>
              <div>No posts found. Check back soon!</div>
            </div>
          </div>
        </div>
      )}
    </div>
  </section>

  <Footer slot="footer" />
</BaseLayout>

<script>
  import '../../scripts/main.ts';
</script>
