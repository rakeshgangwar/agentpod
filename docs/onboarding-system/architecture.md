# Onboarding System Architecture

## System Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Onboarding System Architecture                           │
│                                                                              │
│  ┌─────────────────┐                    ┌─────────────────────────────────┐ │
│  │   Mobile/Desktop│◄──────────────────►│      Management API             │ │
│  │   App           │    REST/SSE        │  (Bun + Hono)                   │ │
│  └─────────────────┘                    │                                 │ │
│         │                               │  • Onboarding session tracking  │ │
│         │                               │  • Knowledge document storage   │ │
│         │                               │  • System agent templates       │ │
│         ▼                               └──────────┬──────────────────────┘ │
│  ┌─────────────────┐                               │                        │
│  │    Sandbox      │                               │ HTTP                   │
│  │   Container     │                               ▼                        │
│  │                 │                    ┌─────────────────────────────────┐ │
│  │  ┌───────────┐  │  MCP (remote)      │  Knowledge Base MCP Server     │ │
│  │  │ OpenCode  │◄─┼───────────────────►│  (Remote HTTP endpoint)         │ │
│  │  │ + Onboard │  │                    │                                 │ │
│  │  │  Agent    │  │                    │  Tools:                         │ │
│  │  └───────────┘  │                    │  • search_knowledge             │ │
│  │                 │                    │  • get_project_template         │ │
│  │  .opencode/     │                    │  • get_agent_pattern            │ │
│  │  ├── agent/     │                    │  • get_command_template         │ │
│  │  │   └── *.md   │                    │  • list_project_types           │ │
│  │  ├── command/   │                    └─────────────────────────────────┘ │
│  │  │   └── *.md   │                                                        │
│  │  └── tool/      │                                                        │
│  │      └── *.ts   │                                                        │
│  │                 │                                                        │
│  │  opencode.json  │  ◄── Injected by entrypoint                           │
│  │  AGENTS.md      │  ◄── Generated by onboarding agent                    │
│  └─────────────────┘                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Components

### 1. Management API

The central API that manages all AgentPod operations.

**Responsibilities:**
- Track onboarding sessions
- Store knowledge base documents
- Serve MCP endpoint for knowledge queries
- Manage user preferences and sandbox lifecycle

**New Endpoints:**
```
POST   /api/onboarding/start              # Start onboarding for sandbox
GET    /api/onboarding/status             # Check if current user needs onboarding (userId from auth)
GET    /api/onboarding/session/:id        # Get session details
PATCH  /api/onboarding/session/:id        # Update session
POST   /api/onboarding/session/:id/skip   # Skip onboarding
POST   /api/onboarding/session/:id/complete # Mark complete
GET    /api/onboarding/history            # Get user's onboarding history

GET    /api/knowledge/:id                 # Get document
GET    /api/knowledge/category/:category  # List documents by category
POST   /api/knowledge/search              # Search documents
POST   /api/knowledge/admin/create        # Create (admin)
PUT    /api/knowledge/admin/:id           # Update (admin)
DELETE /api/knowledge/admin/:id           # Delete (admin)

POST   /api/mcp/knowledge                 # MCP HTTP endpoint
```

### 2. Knowledge Base MCP Server

An MCP server that provides knowledge retrieval tools to OpenCode.

**Implementation Options:**

#### Option A: Integrated (Recommended for MVP)
Run as part of the Management API process.

```typescript
// apps/api/src/routes/mcp-knowledge.ts
app.post('/api/mcp/knowledge', async (c) => {
  // Handle MCP tool calls
});
```

#### Option B: Separate Service
Run as an independent microservice for scalability.

```
┌─────────────────────────────────────────────────────────────────┐
│                  Separate MCP Service                            │
│                                                                  │
│  ┌──────────────┐     ┌──────────────┐     ┌────────────────┐  │
│  │   OpenCode   │────►│  MCP Server  │────►│  Knowledge DB  │  │
│  │  (Container) │     │  (Standalone)│     │  (PostgreSQL)  │  │
│  └──────────────┘     └──────────────┘     └────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

**MCP Tools Provided:**

| Tool | Description | Input | Output |
|------|-------------|-------|--------|
| `search_knowledge` | Semantic/keyword search | `query`, `category?`, `limit?` | Array of documents |
| `get_project_template` | Get full project template | `project_type` | Template with files |
| `get_agent_pattern` | Get agent definition | `role` | Markdown content |
| `get_command_template` | Get command definition | `name` | Markdown content |
| `list_project_types` | List available types | - | Array of type info |

### 3. Sandbox Container

Docker container running OpenCode with injected onboarding configuration.

**Injected Files:**

```
/home/developer/workspace/
├── opencode.json              # Project config with MCP connection
├── AGENTS.md                  # Initial instructions
└── .opencode/
    └── agent/
        └── onboarding.md      # Onboarding agent definition
```

**Environment Variables:**

| Variable | Description |
|----------|-------------|
| `ONBOARDING_MODE` | `true` if onboarding is active |
| `ONBOARDING_SESSION_ID` | Session ID for tracking |
| `ONBOARDING_AGENT_CONTENT` | Agent markdown content |
| `AGENTPOD_API_TOKEN` | Auth token for MCP server |
| `MANAGEMENT_API_URL` | URL of Management API |

### 4. Onboarding Agent

A specialized OpenCode subagent that conducts the onboarding interview.

**Agent Definition (`.opencode/agent/onboarding.md`):**

```markdown
---
description: Helps set up your workspace through conversational interview
mode: subagent
model: anthropic/claude-sonnet-4-20250514
tools:
  write: true
  edit: true
  bash: false
  agentpod_knowledge_*: true
---

[Agent prompt content...]
```

**Capabilities:**
- Access to Knowledge Base MCP tools
- Can write files to workspace
- Can create `.opencode/` configuration
- Cannot execute bash commands (safety)

## Data Flow

### Onboarding Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        Onboarding Data Flow                               │
└──────────────────────────────────────────────────────────────────────────┘

1. User Creates Sandbox
   ┌──────────┐     ┌─────────────┐     ┌──────────────────┐
   │  Mobile  │────►│ Management  │────►│ Check if first   │
   │   App    │     │    API      │     │ sandbox for user │
   └──────────┘     └─────────────┘     └────────┬─────────┘
                                                  │
                           ┌──────────────────────┘
                           ▼
2. Create Onboarding Session
   ┌─────────────┐     ┌──────────────────┐
   │  Database   │◄────│ Create session   │
   │  (sessions) │     │ status: started  │
   └─────────────┘     └──────────────────┘
                                │
                                ▼
3. Inject Onboarding Config into Container
   ┌─────────────────────────────────────────────────────┐
   │  Container Spec                                      │
   │  • ONBOARDING_MODE=true                             │
   │  • ONBOARDING_SESSION_ID=xxx                        │
   │  • ONBOARDING_AGENT_CONTENT=[agent markdown]        │
   │  • AGENTPOD_API_TOKEN=[token]                       │
   └─────────────────────────────────────────────────────┘
                                │
                                ▼
4. Container Starts with Onboarding
   ┌─────────────────────────────────────────────────────┐
   │  entrypoint.sh                                       │
   │  • Creates .opencode/agent/onboarding.md            │
   │  • Creates opencode.json with MCP config            │
   │  • Creates initial AGENTS.md                        │
   └─────────────────────────────────────────────────────┘
                                │
                                ▼
5. User Interacts with Onboarding Agent
   ┌──────────┐     ┌───────────┐     ┌─────────────────┐
   │  User    │────►│ OpenCode  │────►│ @onboarding     │
   │ "Hi!"    │     │           │     │ agent invoked   │
   └──────────┘     └───────────┘     └────────┬────────┘
                                               │
                                               ▼
6. Agent Queries Knowledge Base
   ┌───────────────┐     ┌─────────────────┐     ┌────────────┐
   │  Onboarding   │────►│  MCP Server     │────►│ Knowledge  │
   │    Agent      │     │  /api/mcp/      │     │ Database   │
   │               │◄────│  knowledge      │◄────│            │
   └───────────────┘     └─────────────────┘     └────────────┘
                                │
                                ▼
7. Agent Generates Configuration
   ┌─────────────────────────────────────────────────────┐
   │  Generated Files:                                    │
   │  • opencode.json (updated)                          │
   │  • AGENTS.md (project-specific)                     │
   │  • .opencode/agent/reviewer.md                      │
   │  • .opencode/command/test.md                        │
   └─────────────────────────────────────────────────────┘
                                │
                                ▼
8. Session Marked Complete
   ┌─────────────┐     ┌──────────────────┐
   │  Database   │◄────│ Update session   │
   │  (sessions) │     │ status: complete │
   └─────────────┘     └──────────────────┘
```

### Knowledge Query Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                       Knowledge Query Flow                                │
└──────────────────────────────────────────────────────────────────────────┘

OpenCode                    MCP Server                   Database
   │                            │                            │
   │  Tool Call:                │                            │
   │  search_knowledge          │                            │
   │  {query: "web app"}        │                            │
   │ ──────────────────────────►│                            │
   │                            │  SELECT * FROM             │
   │                            │  knowledge_documents       │
   │                            │  WHERE ...                 │
   │                            │ ──────────────────────────►│
   │                            │                            │
   │                            │◄─────────────────────────  │
   │                            │  [results]                 │
   │                            │                            │
   │◄─────────────────────────  │                            │
   │  {content: [...]}          │                            │
   │                            │                            │
```

## OpenCode Configuration

The onboarding agent can generate ALL OpenCode configuration components. This section documents every configurable aspect.

### Complete Configuration Reference

| Component | Config Location | File Location | Description |
|-----------|-----------------|---------------|-------------|
| **Model** | `opencode.json` → `model` | - | Primary LLM model |
| **Small Model** | `opencode.json` → `small_model` | - | Fast model for lightweight tasks (title generation) |
| **Provider** | `opencode.json` → `provider` | - | Provider configuration and API keys |
| **Agents** | `opencode.json` → `agent` | `.opencode/agent/*.md` | Custom AI agents |
| **Commands** | `opencode.json` → `command` | `.opencode/command/*.md` | Slash commands |
| **Tools** | `opencode.json` → `tools` | `.opencode/tool/*.ts` | Enable/disable tools and custom tools |
| **Plugins** | - | `.opencode/plugin/*.ts` | Event hooks |
| **MCP Servers** | `opencode.json` → `mcp` | - | External tool integrations |
| **Permissions** | `opencode.json` → `permission` | - | Tool access control |
| **Formatters** | `opencode.json` → `formatter` | - | Code formatters |
| **Instructions** | `opencode.json` → `instructions` | `AGENTS.md`, custom files | Project rules |
| **Share** | `opencode.json` → `share` | - | Share feature (`"manual"`, `"auto"`, `"disabled"`) |
| **Autoupdate** | `opencode.json` → `autoupdate` | - | Auto-update settings (`true`, `false`, `"notify"`) |
| **TUI** | `opencode.json` → `tui` | - | TUI settings (scroll_speed, scroll_acceleration) |
| **Theme** | `opencode.json` → `theme` | - | UI theme selection |
| **Keybinds** | `opencode.json` → `keybinds` | - | Custom keyboard shortcuts |
| **Disabled Providers** | `opencode.json` → `disabled_providers` | - | Array of provider IDs to disable |

### Built-in Tools Reference

OpenCode provides these built-in tools that the LLM can use:

| Tool | Description | Default |
|------|-------------|---------|
| `bash` | Execute shell commands in your project environment | Enabled |
| `edit` | Modify existing files using exact string replacements | Enabled |
| `write` | Create new files or overwrite existing ones | Enabled |
| `read` | Read file contents (supports specific line ranges) | Enabled |
| `grep` | Search file contents using regular expressions | Enabled |
| `glob` | Find files by pattern matching (e.g., `**/*.ts`) | Enabled |
| `list` | List files and directories in a given path | Enabled |
| `patch` | Apply patches/diffs to files | Enabled |
| `todowrite` | Create and manage task lists during sessions | Enabled (disabled for subagents) |
| `todoread` | Read existing todo list state | Enabled (disabled for subagents) |
| `webfetch` | Fetch and read web pages | Enabled |

**Configuring Tools:**

```json
{
  "tools": {
    "write": true,
    "bash": true,
    "webfetch": false,
    "mymcp_*": false
  }
}
```

Tools can be enabled/disabled globally or per-agent. Wildcards are supported for MCP server tools.

### Injected `opencode.json` (Initial)

```json
{
  "$schema": "https://opencode.ai/config.json",
  "mcp": {
    "agentpod_knowledge": {
      "type": "remote",
      "url": "{env:MANAGEMENT_API_URL}/api/mcp/knowledge",
      "headers": {
        "Authorization": "Bearer {env:AGENTPOD_API_TOKEN}"
      }
    }
  },
  "instructions": [".opencode/agent/onboarding.md"]
}
```

### After Onboarding Complete (Full Example)

The agent generates a complete configuration based on project type:

```json
{
  "$schema": "https://opencode.ai/config.json",
  "model": "anthropic/claude-sonnet-4-20250514",
  "small_model": "anthropic/claude-haiku",
  "share": "manual",
  "autoupdate": true,
  "mcp": {
    "agentpod_knowledge": {
      "type": "remote",
      "url": "https://api.agentpod.io/mcp/knowledge",
      "enabled": true,
      "headers": {
        "Authorization": "Bearer {env:AGENTPOD_API_TOKEN}"
      }
    },
    "context7": {
      "type": "remote",
      "url": "https://mcp.context7.com/mcp"
    },
    "database": {
      "type": "local",
      "command": ["npx", "-y", "@agentpod/mcp-database", "--connection", "{env:DATABASE_URL}"],
      "environment": {
        "DATABASE_URL": "{env:DATABASE_URL}"
      },
      "timeout": 10000
    }
  },
  "agent": {
    "reviewer": {
      "description": "Reviews code for quality and best practices",
      "mode": "subagent",
      "model": "anthropic/claude-sonnet-4-20250514",
      "temperature": 0.3,
      "maxSteps": 10,
      "tools": {
        "read": true,
        "glob": true,
        "grep": true,
        "write": false,
        "edit": false
      },
      "permission": {
        "edit": "deny",
        "bash": "deny"
      }
    },
    "architect": {
      "description": "Plans system architecture and designs solutions",
      "mode": "subagent"
    }
  },
  "command": {
    "test": {
      "description": "Run tests with analysis",
      "template": "Run the test suite and analyze failures. $ARGUMENTS"
    },
    "review": {
      "description": "Review code changes",
      "agent": "reviewer",
      "subtask": true
    }
  },
  "permission": {
    "edit": "allow",
    "bash": {
      "npm *": "allow",
      "pnpm *": "allow",
      "git *": "allow",
      "rm -rf *": "deny",
      "*": "ask"
    },
    "webfetch": "ask",
    "doom_loop": "ask",
    "external_directory": "ask"
  },
  "formatter": {
    "prettier": {
      "command": ["npx", "prettier", "--write", "$FILE"],
      "extensions": [".ts", ".tsx", ".js", ".jsx", ".json", ".md"]
    }
  },
  "instructions": ["AGENTS.md", ".opencode/rules/*.md"]
}
```

### Agents Configuration

Agents can be defined in two ways:

#### 1. In `opencode.json`

```json
{
  "agent": {
    "reviewer": {
      "description": "Reviews code for quality",
      "mode": "subagent",
      "model": "anthropic/claude-sonnet-4-20250514",
      "temperature": 0.1,
      "maxSteps": 10,
      "prompt": "{file:./prompts/reviewer.txt}",
      "tools": {
        "read": true,
        "glob": true,
        "grep": true,
        "write": false,
        "edit": false
      },
      "permission": {
        "edit": "deny",
        "bash": "deny"
      }
    }
  }
}
```

#### 2. In `.opencode/agent/*.md` (Recommended for complex prompts)

```markdown
---
description: Reviews code for quality and best practices
mode: subagent
model: anthropic/claude-sonnet-4-20250514
temperature: 0.1
maxSteps: 10
tools:
  write: false
  edit: false
  bash: false
permission:
  edit: deny
  bash: deny
---

You are a code reviewer. Analyze code for:

1. **Code Quality**: Clean code principles, readability
2. **Performance**: Efficiency, complexity issues
3. **Security**: Vulnerabilities, input validation
4. **Best Practices**: Language idioms, patterns

Format your review as:
- Summary
- Issues (Critical/Warning/Info)
- Recommendations
```

#### Agent Options Reference

| Option | Type | Description |
|--------|------|-------------|
| `description` | string | **(Required)** Shown in agent list |
| `mode` | `"primary"` \| `"subagent"` \| `"all"` | Agent mode (default: `"all"`) |
| `model` | string | Override default model |
| `temperature` | number (0-1) | Creativity (defaults to 0 for most models, 0.55 for Qwen models) |
| `maxSteps` | number | Max agentic iterations before forced text response |
| `prompt` | string | Custom system prompt (supports `{file:path}` syntax) |
| `disable` | boolean | Set to `true` to disable the agent |
| `tools` | object | Tool access control with boolean values (supports wildcards: `mcp_*`) |
| `permission` | object | Per-tool permission overrides (`"allow"`, `"ask"`, `"deny"`) |

### Commands Configuration

Commands can be defined in two ways:

#### 1. In `opencode.json`

```json
{
  "command": {
    "test": {
      "description": "Run tests",
      "template": "Run the test suite: $ARGUMENTS",
      "agent": "build",
      "model": "anthropic/claude-sonnet-4-20250514"
    },
    "review": {
      "description": "Review code changes",
      "template": "Review the following changes",
      "agent": "reviewer",
      "subtask": true
    }
  }
}
```

#### 2. In `.opencode/command/*.md`

```markdown
---
description: Run the test suite and analyze failures
agent: build
subtask: false
model: anthropic/claude-sonnet-4-20250514
---

Run the test suite for this project.

$ARGUMENTS

After running tests:
1. Analyze any failures
2. Suggest fixes for failing tests
3. Report coverage if available
```

#### Command Options Reference

| Option | Type | Description |
|--------|------|-------------|
| `description` | string | Shown in the TUI when typing the command |
| `template` | string | The prompt sent to the LLM (required for JSON config) |
| `agent` | string | Which agent should execute the command |
| `subtask` | boolean | Force command to run as subagent (useful to not pollute primary context) |
| `model` | string | Override the default model for this command |

#### Prompt Features

**Arguments:**

Use `$ARGUMENTS` to include all arguments passed to the command:

```markdown
Create a new component named $ARGUMENTS with TypeScript support.
```

**Positional Arguments:**

Use `$1`, `$2`, `$3`, etc. for individual arguments:

```markdown
---
description: Create a file with content
---

Create a file named $1 in the directory $2
with the following content: $3
```

Usage: `/create-file config.json src "{ \"key\": \"value\" }"`

**Shell Output:**

Use `` !`command` `` to inject shell command output into your prompt:

```markdown
---
description: Analyze test coverage
---

Here are the current test results:
!`npm test`

Based on these results, suggest improvements to increase coverage.
```

**File References:**

Use `@` followed by the filename to include file contents:

```markdown
---
description: Review component
---

Review the component in @src/components/Button.tsx.
Check for performance issues and suggest improvements.
```

### Custom Tools

Custom tools are TypeScript/JavaScript files in `.opencode/tool/*.ts` or `~/.config/opencode/tool/`.

The **filename becomes the tool name** (e.g., `database.ts` creates a `database` tool).

```typescript
// .opencode/tool/database.ts
import { tool } from "@opencode-ai/plugin";

export default tool({
  description: "Execute a read-only SQL query",
  args: {
    query: tool.schema.string().describe("The SQL query to execute")
  },
  async execute(args, context) {
    // context provides: { agent, sessionID, messageID }
    
    // Validate query is read-only
    if (!/^\s*SELECT/i.test(args.query)) {
      throw new Error("Only SELECT queries allowed");
    }
    // Execute and return results
    const results = await db.query(args.query);
    return JSON.stringify(results, null, 2);
  }
});
```

#### Key Points:
- Uses `args` (not `parameters`) with `tool.schema` (which is Zod) for argument definitions
- `execute` receives `(args, context)` where context has `{ agent, sessionID, messageID }`
- No `name` property needed - filename becomes the tool name
- The `description` field is shown to the LLM

#### Multiple Tools Per File

Export multiple tools from a single file. Each export becomes a separate tool with the name `<filename>_<exportname>`:

```typescript
// .opencode/tool/math.ts
import { tool } from "@opencode-ai/plugin";

export const add = tool({
  description: "Add two numbers",
  args: {
    a: tool.schema.number().describe("First number"),
    b: tool.schema.number().describe("Second number")
  },
  async execute(args) {
    return args.a + args.b;
  }
});

export const multiply = tool({
  description: "Multiply two numbers",
  args: {
    a: tool.schema.number().describe("First number"),
    b: tool.schema.number().describe("Second number")
  },
  async execute(args) {
    return args.a * args.b;
  }
});
```

This creates two tools: `math_add` and `math_multiply`.

#### Tools in Other Languages

You can write tools in any language. The TypeScript definition invokes the script:

```typescript
// .opencode/tool/python-add.ts
import { tool } from "@opencode-ai/plugin";

export default tool({
  description: "Add two numbers using Python",
  args: {
    a: tool.schema.number().describe("First number"),
    b: tool.schema.number().describe("Second number")
  },
  async execute(args) {
    const result = await Bun.$`python3 .opencode/tool/add.py ${args.a} ${args.b}`.text();
    return result.trim();
  }
});
```

### Plugins

Plugins hook into OpenCode events. Define in `.opencode/plugin/*.ts` or `~/.config/opencode/plugin/`:

```typescript
// .opencode/plugin/session-logger.ts
import type { Plugin } from "@opencode-ai/plugin";

export const SessionLogger: Plugin = async ({ project, client, $, directory, worktree }) => {
  console.log("Plugin initialized!");
  
  return {
    // Generic event handler for all events
    event: async ({ event }) => {
      if (event.type === "session.created") {
        console.log(`Session started!`);
      }
      if (event.type === "session.idle") {
        console.log(`Session became idle`);
      }
    },
    
    // Or use specific event handlers
    "tool.execute.before": async (input, output) => {
      console.log(`Tool: ${input.tool} Args: ${JSON.stringify(output.args)}`);
    },
    
    "tool.execute.after": async (input, output) => {
      console.log(`Tool completed: ${input.tool}`);
    }
  };
};
```

The plugin function receives a context object with:
- `project`: The current project information
- `directory`: The current working directory
- `worktree`: The git worktree path
- `client`: An OpenCode SDK client for interacting with the AI
- `$`: Bun's shell API for executing commands

#### Plugin Hooks

Plugins can return several types of hooks:

| Hook | Description |
|------|-------------|
| `event` | Generic handler for all events |
| `tool` | Add custom tools to OpenCode |
| `config` | Modify configuration at runtime |
| `auth` | Custom authentication providers |
| Specific events | Handle specific events like `tool.execute.before` |

**Adding Custom Tools via Plugin:**

```typescript
// .opencode/plugin/custom-tools.ts
import { type Plugin, tool } from "@opencode-ai/plugin";

export const CustomToolsPlugin: Plugin = async (ctx) => {
  return {
    tool: {
      mytool: tool({
        description: "This is a custom tool",
        args: {
          foo: tool.schema.string().describe("A string argument"),
        },
        async execute(args, context) {
          return `Hello ${args.foo}!`;
        },
      }),
    },
  };
};
```

The `tool` helper creates custom tools with:
- `description`: What the tool does (shown to LLM)
- `args`: Zod schema for arguments
- `execute`: Function that runs when the tool is called

#### Available Plugin Events

**Command Events:**
| Event | Description |
|-------|-------------|
| `command.executed` | A command was executed |

**File Events:**
| Event | Description |
|-------|-------------|
| `file.edited` | File was modified |
| `file.watcher.updated` | File system change detected |

**Installation Events:**
| Event | Description |
|-------|-------------|
| `installation.updated` | Installation was updated |

**LSP Events:**
| Event | Description |
|-------|-------------|
| `lsp.client.diagnostics` | LSP diagnostics received |
| `lsp.updated` | LSP state updated |

**Message Events:**
| Event | Description |
|-------|-------------|
| `message.part.removed` | Message part was removed |
| `message.part.updated` | Streaming update received |
| `message.removed` | Message was removed |
| `message.updated` | Message content changed |

**Permission Events:**
| Event | Description |
|-------|-------------|
| `permission.replied` | User answered permission prompt |
| `permission.updated` | Permission setting changed |

**Server Events:**
| Event | Description |
|-------|-------------|
| `server.connected` | Server connection established |

**Session Events:**
| Event | Description |
|-------|-------------|
| `session.created` | New session started |
| `session.compacted` | Context was compacted |
| `session.deleted` | Session was deleted |
| `session.diff` | Session diff available |
| `session.error` | Error occurred |
| `session.idle` | Session became idle |
| `session.status` | Session status changed |
| `session.updated` | Session was updated |

**Todo Events:**
| Event | Description |
|-------|-------------|
| `todo.updated` | Todo list was updated |

**Tool Events:**
| Event | Description |
|-------|-------------|
| `tool.execute.before` | Before tool runs |
| `tool.execute.after` | After tool completes |

**TUI Events:**
| Event | Description |
|-------|-------------|
| `tui.prompt.append` | Append to TUI prompt |
| `tui.command.execute` | Execute TUI command |
| `tui.toast.show` | Show toast notification |

#### Example Plugins

**Environment Protection Plugin:**
```typescript
// .opencode/plugin/env-protection.ts
import type { Plugin } from "@opencode-ai/plugin";

export const EnvProtection: Plugin = async ({ project, client, $, directory, worktree }) => {
  return {
    "tool.execute.before": async (input, output) => {
      if (input.tool === "read" && output.args.filePath?.includes(".env")) {
        throw new Error("Do not read .env files");
      }
    }
  };
};
```

**Notification Plugin:**
```typescript
// .opencode/plugin/notification.ts
import type { Plugin } from "@opencode-ai/plugin";

export const NotificationPlugin: Plugin = async ({ project, client, $, directory, worktree }) => {
  return {
    event: async ({ event }) => {
      if (event.type === "session.idle") {
        await $`osascript -e 'display notification "Session completed!" with title "opencode"'`;
      }
    }
  };
};
```

### MCP Servers

MCP (Model Context Protocol) servers provide external tools:

#### Local MCP Server (stdio)

```json
{
  "mcp": {
    "filesystem": {
      "type": "local",
      "command": ["npx", "-y", "@modelcontextprotocol/server-filesystem", "/path/to/allowed/directory"],
      "enabled": true,
      "environment": {
        "NODE_ENV": "production"
      },
      "timeout": 5000
    }
  }
}
```

**Local MCP Options:**

| Option | Type | Required | Description |
|--------|------|----------|-------------|
| `type` | string | Yes | Must be `"local"` |
| `command` | array | Yes | Command and arguments to run the MCP server |
| `enabled` | boolean | No | Enable or disable the MCP server (default: true) |
| `environment` | object | No | Environment variables to set when running |
| `timeout` | number | No | Timeout in ms for fetching tools (default: 5000) |

#### Remote MCP Server (HTTP)

```json
{
  "mcp": {
    "context7": {
      "type": "remote",
      "url": "https://mcp.context7.com/mcp"
    },
    "agentpod_knowledge": {
      "type": "remote",
      "url": "https://api.agentpod.io/mcp/knowledge",
      "enabled": true,
      "headers": {
        "Authorization": "Bearer {env:AGENTPOD_API_TOKEN}"
      },
      "timeout": 10000
    }
  }
}
```

**Remote MCP Options:**

| Option | Type | Required | Description |
|--------|------|----------|-------------|
| `type` | string | Yes | Must be `"remote"` |
| `url` | string | Yes | URL of the remote MCP server |
| `enabled` | boolean | No | Enable or disable the MCP server |
| `headers` | object | No | Headers to send with requests |
| `oauth` | object/false | No | OAuth authentication config (see below) |
| `timeout` | number | No | Timeout in ms for fetching tools (default: 5000) |

#### OAuth-Protected MCP Server

OpenCode automatically handles OAuth authentication. For most OAuth-enabled servers, no special configuration is needed:

```json
{
  "mcp": {
    "my-oauth-server": {
      "type": "remote",
      "url": "https://mcp.example.com/mcp"
    }
  }
}
```

**With pre-registered client credentials:**

```json
{
  "mcp": {
    "my-oauth-server": {
      "type": "remote",
      "url": "https://mcp.example.com/mcp",
      "oauth": {
        "clientId": "{env:MY_MCP_CLIENT_ID}",
        "clientSecret": "{env:MY_MCP_CLIENT_SECRET}",
        "scope": "tools:read tools:execute"
      }
    }
  }
}
```

**To disable OAuth for API key servers:**

```json
{
  "mcp": {
    "my-api-key-server": {
      "type": "remote",
      "url": "https://mcp.example.com/mcp",
      "oauth": false,
      "headers": {
        "Authorization": "Bearer {env:MY_API_KEY}"
      }
    }
  }
}
```

### Permissions

Control tool access per-tool. By default, OpenCode allows most operations without approval, **except** `doom_loop` and `external_directory` which default to `"ask"`.

```json
{
  "permission": {
    "edit": "allow",
    "bash": {
      "npm *": "allow",
      "pnpm *": "allow",
      "yarn *": "allow",
      "git *": "allow",
      "make *": "allow",
      "rm -rf *": "deny",
      "sudo *": "deny",
      "*": "ask"
    },
    "webfetch": "ask",
    "doom_loop": "ask",
    "external_directory": "ask"
  }
}
```

#### Permission Values

| Value | Behavior |
|-------|----------|
| `"allow"` | Always permit without asking |
| `"deny"` | Always block |
| `"ask"` | Prompt user each time |

#### Available Permission Types

| Permission | Description | Default |
|------------|-------------|---------|
| `edit` | File editing operations | `"allow"` |
| `bash` | Shell command execution | `"allow"` |
| `webfetch` | Fetching web pages | `"allow"` |
| `doom_loop` | Controls approval when same tool is called 3x with identical args | `"ask"` |
| `external_directory` | File operations outside working directory | `"ask"` |

#### Permission Patterns for Bash

Bash permissions support glob patterns for fine-grained control:

```json
{
  "permission": {
    "bash": {
      "npm test": "allow",
      "npm run *": "allow",
      "git status": "allow",
      "git commit *": "ask",
      "rm -rf /": "deny",
      "curl * | sh": "deny",
      "*": "ask"
    }
  }
}
```

**Glob Pattern Syntax:**
- `*` matches zero or more of any character
- `?` matches exactly one character
- All other characters match literally

When the user selects "accept always" for a bash command, the permission applies to the first two elements (e.g., `git log` whitelists `git log *` but not `git commit`).

### Formatters

Configure code formatters that run on file save. OpenCode comes with built-in formatters for popular languages (prettier, gofmt, ruff, etc.) that work automatically when detected.

**Custom Formatter Configuration:**

```json
{
  "formatter": {
    "prettier": {
      "command": ["npx", "prettier", "--write", "$FILE"],
      "extensions": [".ts", ".tsx", ".js", ".jsx", ".json", ".md", ".css"],
      "environment": {
        "NODE_ENV": "development"
      }
    },
    "black": {
      "command": ["black", "$FILE"],
      "extensions": [".py"]
    },
    "rustfmt": {
      "command": ["rustfmt", "$FILE"],
      "extensions": [".rs"]
    },
    "gofmt": {
      "command": ["gofmt", "-w", "$FILE"],
      "extensions": [".go"]
    }
  }
}
```

**Formatter Options:**

| Option | Type | Description |
|--------|------|-------------|
| `command` | array | The command to run for formatting (`$FILE` is replaced with file path) |
| `extensions` | array | File extensions this formatter should handle (e.g., `[".js", ".ts"]`) |
| `environment` | object | Environment variables to set when running the formatter |
| `disabled` | boolean | Set to `true` to disable the formatter |

**To disable all formatters:**

```json
{
  "formatter": false
}
```

**To disable a specific formatter:**

```json
{
  "formatter": {
    "prettier": {
      "disabled": true
    }
  }
}
```

### Instructions (Rules)

Project-specific instructions can be defined:

```json
{
  "instructions": [
    "AGENTS.md",
    ".opencode/rules/*.md",
    ".cursor/rules/*.md"
  ]
}
```

Supports glob patterns to include multiple files.

### Variable Substitution

OpenCode supports variable substitution in configuration files:

#### Environment Variables

Use `{env:VARIABLE_NAME}` to substitute environment variables:

```json
{
  "model": "{env:OPENCODE_MODEL}",
  "mcp": {
    "my-server": {
      "type": "remote",
      "url": "https://mcp.example.com",
      "headers": {
        "Authorization": "Bearer {env:MY_API_KEY}"
      }
    }
  }
}
```

If the environment variable is not set, it will be replaced with an empty string.

#### File Contents

Use `{file:path/to/file}` to substitute the contents of a file:

```json
{
  "agent": {
    "reviewer": {
      "prompt": "{file:./prompts/reviewer.txt}"
    }
  },
  "provider": {
    "openai": {
      "options": {
        "apiKey": "{file:~/.secrets/openai-key}"
      }
    }
  }
}
```

File paths can be:
- Relative to the config file directory
- Absolute paths starting with `/` or `~`

This is useful for:
- Keeping sensitive data like API keys in separate files
- Including large instruction files without cluttering your config
- Sharing common configuration snippets across multiple config files

## Security Considerations

### Token Scoping

The `AGENTPOD_API_TOKEN` should be scoped to:
- Read-only access to knowledge base
- Write access only to own onboarding session
- No access to other users' data

### MCP Server Authentication

```typescript
// Validate token on each MCP request
app.post('/api/mcp/knowledge', async (c) => {
  const token = c.req.header('Authorization')?.replace('Bearer ', '');
  
  const sandbox = await validateSandboxToken(token);
  if (!sandbox) {
    return c.json({ error: 'Unauthorized' }, 401);
  }
  
  // Process MCP request...
});
```

### Agent Permissions

The onboarding agent has restricted permissions:
- `bash: false` - Cannot execute shell commands
- `write: true` - Can create configuration files
- `edit: true` - Can modify configuration files

## Scalability Considerations

### Knowledge Base Caching

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        Caching Strategy                                   │
└──────────────────────────────────────────────────────────────────────────┘

┌───────────┐     ┌─────────┐     ┌─────────────┐     ┌────────────┐
│  OpenCode │────►│  Redis  │────►│  MCP Server │────►│  Database  │
│           │     │  Cache  │     │             │     │            │
└───────────┘     └─────────┘     └─────────────┘     └────────────┘

Cache TTL by document type:
- project_template: 1 hour
- agent_pattern: 1 hour
- command_template: 1 hour
- best_practice: 6 hours
```

### Database Indexing

```sql
-- Indexes for common queries
CREATE INDEX idx_knowledge_category ON knowledge_documents(category);
CREATE INDEX idx_knowledge_tags ON knowledge_documents(tags);
CREATE INDEX idx_onboarding_user ON onboarding_sessions(user_id);
CREATE INDEX idx_onboarding_status ON onboarding_sessions(status);
```

## Error Handling

### Graceful Degradation

If the MCP server is unavailable:
1. Onboarding agent falls back to generic prompts
2. User can still work without onboarding
3. Session status updated to `failed` with error details

### Retry Strategy

```typescript
// MCP client with retry
const mcpClient = {
  async callTool(name: string, args: any, retries = 3) {
    for (let i = 0; i < retries; i++) {
      try {
        return await this.call(name, args);
      } catch (error) {
        if (i === retries - 1) throw error;
        await sleep(1000 * Math.pow(2, i)); // Exponential backoff
      }
    }
  }
};
```

## Monitoring

### Metrics to Track

| Metric | Description |
|--------|-------------|
| `onboarding.started` | Sessions started |
| `onboarding.completed` | Sessions completed |
| `onboarding.skipped` | Sessions skipped |
| `onboarding.failed` | Sessions failed |
| `onboarding.duration` | Time to complete |
| `mcp.requests` | MCP tool calls |
| `mcp.latency` | MCP response time |
| `knowledge.searches` | Search queries |
| `knowledge.cache_hits` | Cache hit rate |

### Logging

```typescript
// Structured logging for onboarding events
logger.info('onboarding.session.created', {
  sessionId: session.id,
  userId: session.userId,
  sandboxId: session.sandboxId
});

logger.info('onboarding.tool.called', {
  sessionId: session.id,
  tool: 'search_knowledge',
  query: args.query,
  resultsCount: results.length,
  latencyMs: duration
});
```
