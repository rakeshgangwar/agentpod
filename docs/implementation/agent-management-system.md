# Agent Management System - Implementation Plan

**Application:** CodeOpen  
**Date:** December 2024  
**Status:** Planning

---

## Table of Contents

1. [Overview](#overview)
2. [Terminology](#terminology)
3. [Architecture](#architecture)
4. [Data Models](#data-models)
5. [User Flows](#user-flows)
6. [UI Components](#ui-components)
7. [Backend Implementation](#backend-implementation)
8. [Frontend Implementation](#frontend-implementation)
9. [Authentication Flows](#authentication-flows)
10. [Implementation Phases](#implementation-phases)
11. [File Changes Summary](#file-changes-summary)

---

## Overview

This document outlines the implementation plan for integrating multiple AI coding agents (Claude Code, Gemini CLI, Codex, etc.) into CodeOpen using the Agent Client Protocol (ACP).

### Goals

1. Allow users to select different **AI Assistants** (agent harnesses) per chat session
2. Support **Agent Modes** (personas/internal agents) within each AI Assistant
3. Pre-install common AI Assistants with ability to add custom ones
4. Implement device flow authentication for OAuth-based providers
5. Maintain OpenCode as the default AI Assistant

### Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Agent scope | Per-session | Users can use different agents for different tasks |
| Default agent | OpenCode | Open-source, no auth required, works out-of-box |
| Pre-installed agents | OpenCode, Claude Code, Gemini CLI, Codex | Most popular options |
| Auth pattern | Device flow | Works in container environments |
| UI location | Settings tab + Chat picker | Management in settings, quick access in chat |

---

## Terminology

### User-Facing Terms

| Term | Definition | Examples |
|------|------------|----------|
| **AI Assistant** | External AI coding tool that implements ACP | OpenCode, Claude Code, Gemini CLI, Codex, Goose |
| **Agent Mode** | Behavior/persona within an AI Assistant | "Code Reviewer", "Build Agent", "Documentation Writer" |

### Technical Terms

| Term | Definition |
|------|------------|
| **Agent Harness** | Backend term for AI Assistant - the ACP-compliant subprocess |
| **Internal Agent** | Backend term for Agent Mode - prompt/instruction definitions |
| **ACP Gateway** | Service that orchestrates multiple agent harnesses |
| **ACP Session** | A conversation context within an agent harness |

### Relationship Diagram

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                           USER SESSION                               โ
โ  "Help me refactor the authentication module"                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                   โ
                                   โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    AI ASSISTANT (Agent Harness)                      โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ โ
โ  โ  OpenCode   โ  โ Claude Code โ  โ Gemini CLI  โ  โ   Codex     โ โ
โ  โ  (default)  โ  โ             โ  โ             โ  โ             โ โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                   โ
                                   โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    AGENT MODE (Internal Agent)                       โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ โ
โ  โ   Default   โ  โ   Coder     โ  โ   Reviewer  โ  โ   Custom    โ โ
โ  โ             โ  โ             โ  โ             โ  โ             โ โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## Architecture

### System Overview

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                              FRONTEND                                    โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ โ
โ  โ  Settings   โ  โ    Chat     โ  โ  Assistant  โ  โ  Auth Modals    โ โ
โ  โ  (Agents)   โ  โ  Interface  โ  โ   Picker    โ  โ  (OAuth/API)    โ โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                   โ
                                   โผ Tauri IPC
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                           TAURI BACKEND                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                    New Agent Commands                                โโ
โ  โ  โข list_agents, get_agent, spawn_agent, stop_agent                  โโ
โ  โ  โข init_agent_auth, complete_agent_auth, get_agent_auth_status      โโ
โ  โ  โข add_custom_agent, remove_custom_agent                            โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                   โ
                                   โผ HTTP
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         MANAGEMENT API                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                   Agent Proxy Endpoints                              โโ
โ  โ  GET  /api/agents              - List all agents                     โโ
โ  โ  GET  /api/agents/:id          - Get agent details                   โโ
โ  โ  POST /api/agents/:id/spawn    - Start agent process                 โโ
โ  โ  POST /api/agents/:id/stop     - Stop agent process                  โโ
โ  โ  GET  /api/agents/:id/status   - Get agent status                    โโ
โ  โ  POST /api/agents/:id/auth     - Initialize auth                     โโ
โ  โ  POST /api/agents/:id/auth/complete - Complete auth                  โโ
โ  โ  POST /api/agents/custom       - Add custom agent                    โโ
โ  โ  DELETE /api/agents/:id        - Remove custom agent                 โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                   โ
                                   โผ HTTP (Internal Network)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                          ACP GATEWAY                                     โ
โ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Agent Registryโ  โ Agent Manager โ  โ     Session Manager           โโ
โ  โ               โ  โ               โ  โ                               โโ
โ  โ โข OpenCode    โ  โ โข Spawn/Stop  โ  โ โข Create/Delete sessions      โโ
โ  โ โข Claude Code โ  โ โข Health      โ  โ โข Route messages              โโ
โ  โ โข Gemini CLI  โ  โ โข Auth inject โ  โ โข Handle permissions          โโ
โ  โ โข Codex       โ  โ               โ  โ                               โโ
โ  โ โข Custom...   โ  โ               โ  โ                               โโ
โ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                   โ
                                   โผ stdio (JSON-RPC)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                       AGENT SUBPROCESSES                                 โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ โ
โ  โ  opencode   โ  โ claude-code โ  โ   gemini    โ  โ   codex-acp     โ โ
โ  โ    acp      โ  โ    -acp     โ  โ --exp-acp   โ  โ                 โ โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Container Integration

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        DOCKER CONTAINER                                  โ
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Pre-installed Binaries/Packages                                      โโ
โ  โ โข opencode (default)                                                 โโ
โ  โ โข @zed-industries/claude-code-acp (npm global)                       โโ
โ  โ โข @zed-industries/codex-acp (npm global)                             โโ
โ  โ โข gemini-cli (if available via package manager)                      โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ User-installed (on-demand)                                           โโ
โ  โ โข Custom agents via npm install                                      โโ
โ  โ โข Local binaries at custom paths                                     โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Services                                                             โโ
โ  โ โข ACP Gateway (port 4097)                                            โโ
โ  โ โข OpenCode API (port 4096) - for direct OpenCode access              โโ
โ  โ โข Code Server, VNC, etc.                                             โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## Data Models

### AI Assistant (Agent Harness)

```typescript
// packages/types/src/agent.ts

export type AgentId = string;

export type AgentStatus = 
  | 'stopped'      // Not running
  | 'starting'     // Process spawning
  | 'running'      // Active and ready
  | 'error'        // Failed to start or crashed
  | 'auth_required'; // Needs authentication

export type AuthType = 'none' | 'oauth' | 'device_flow' | 'api_key';

export type AuthFlowType = 
  | 'code_first'   // GitHub Copilot style: app shows code, user enters on URL
  | 'url_first';   // Claude Code style: user visits URL, copies code back

export interface AgentConfig {
  id: AgentId;
  name: string;
  description: string;
  command: string;
  args: string[];
  requiresAuth: boolean;
  authType: AuthType;
  authFlowType?: AuthFlowType;
  authProvider?: string;
  authUrl?: string;
  envVars?: Record<string, string>;
  isBuiltIn: boolean;      // Pre-installed vs user-added
  isDefault: boolean;      // Workspace default
  iconUrl?: string;        // Optional icon
}

export interface AgentInstance {
  id: AgentId;
  config: AgentConfig;
  status: AgentStatus;
  authenticated: boolean;
  startedAt: Date | null;
  lastActivity: Date | null;
  error: string | null;
  sessionCount: number;
}

export interface AgentAuthState {
  agentId: AgentId;
  status: 'idle' | 'pending' | 'completed' | 'failed';
  flowType: AuthFlowType;
  // For code_first (GitHub style)
  userCode?: string;
  verificationUrl?: string;
  // For url_first (Claude style)
  authUrl?: string;
  // Common
  expiresAt?: Date;
  error?: string;
}
```

### Agent Mode (Internal Agent)

```typescript
// packages/types/src/agent.ts

export interface AgentMode {
  id: string;
  name: string;
  description: string;
  // Source of the mode
  source: 'builtin' | 'custom';
  // Which AI Assistant this mode belongs to (or 'all' for universal)
  assistantId: AgentId | 'all';
  // For custom modes: the prompt/instructions
  systemPrompt?: string;
  // OpenCode-specific: maps to agent ID from /agent endpoint
  opencodeAgentId?: string;
}
```

### Session with Agent Selection

```typescript
// Extend existing Session type
export interface Session {
  id: string;
  projectId: string;
  // NEW: Agent selection
  assistantId: AgentId;        // Which AI Assistant
  agentModeId?: string;        // Which Agent Mode (optional)
  // Existing fields
  status: SessionStatus;
  createdAt: Date;
  lastActivity: Date;
  messageCount: number;
  // ...
}
```

### API Response Types

```typescript
// packages/types/src/api.ts

export interface AgentListResponse {
  assistants: AgentInstance[];
  defaultAssistantId: AgentId;
}

export interface AgentModesResponse {
  modes: AgentMode[];
  defaultModeId?: string;
}

export interface AgentAuthInitResponse {
  flowType: AuthFlowType;
  // code_first
  userCode?: string;
  verificationUrl?: string;
  // url_first
  authUrl?: string;
  // Common
  expiresIn: number;
  message: string;
}

export interface AgentAuthCompleteRequest {
  // For url_first flow
  code?: string;
  // For code_first flow (usually automatic via polling)
  token?: string;
}
```

---

## User Flows

### Flow 1: First-Time User Experience

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. USER OPENS NEW PROJECT                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  โข Project container starts                                              โ
โ  โข ACP Gateway initializes                                               โ
โ  โข OpenCode (default) is auto-spawned                                    โ
โ  โข User is taken to Chat tab                                             โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. USER STARTS CHATTING                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Chat Header                                                          โโ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโ
โ  โ โ AI Assistant: [๐ค OpenCode โพ]  Mode: [Default โพ]                โ โโ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โ  โข OpenCode is pre-selected as default                                   โ
โ  โข User can immediately start chatting                                   โ
โ  โข No authentication required                                            โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3. USER EXPLORES OTHER ASSISTANTS (Optional)                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  User clicks Assistant dropdown:                                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ ๐ค OpenCode              โ Active                                   โโ
โ  โ ๐ง Claude Code           ๐ Sign in required                        โโ
โ  โ ๐ Gemini CLI            ๐ Sign in required                        โโ
โ  โ ๐ฎ Codex                 ๐ API key required                        โโ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโ
โ  โ โ๏ธ Manage AI Assistants...                                          โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Flow 2: Authenticating with Claude Code

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. USER SELECTS CLAUDE CODE                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  User clicks "Claude Code" in dropdown                                   โ
โ  System detects: not authenticated                                       โ
โ  Auth modal opens automatically                                          โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. AUTH MODAL (URL-First / Claude Style)                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Sign in to Claude Code                                          [X] โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  โ                                                                      โโ
โ  โ  ๐ง Claude Code                                                      โโ
โ  โ                                                                      โโ
โ  โ  Sign in with your Anthropic account to use Claude Code.            โโ
โ  โ  Requires Claude Pro or Max subscription.                           โโ
โ  โ                                                                      โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ  โ Step 1: Click the button below to sign in                       โโโ
โ  โ  โ                                                                 โโโ
โ  โ  โ              [๐ Sign in with Anthropic]                        โโโ
โ  โ  โ                                                                 โโโ
โ  โ  โ Step 2: After signing in, you'll receive a code.               โโโ
โ  โ  โ         Paste it below:                                         โโโ
โ  โ  โ                                                                 โโโ
โ  โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโโ
โ  โ  โ โ Enter code from browser...                                  โ โโโ
โ  โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโโ
โ  โ  โ                                                                 โโโ
โ  โ  โ โณ Waiting for code...                                          โโโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                                                                      โโ
โ  โ                                                   [Cancel] [Verify] โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3. USER COMPLETES AUTH                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  โข User clicks "Sign in with Anthropic"                                  โ
โ  โข Browser opens to Anthropic auth page                                  โ
โ  โข User signs in, grants permission                                      โ
โ  โข Browser shows code (e.g., "ABCD-1234-EFGH")                          โ
โ  โข User copies code, pastes into modal                                   โ
โ  โข Clicks "Verify"                                                       โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 4. AUTH SUCCESS                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ โ Successfully signed in to Claude Code!                           โโ
โ  โ                                                                      โโ
โ  โ You can now use Claude Code as your AI Assistant.                   โโ
โ  โ                                                                      โโ
โ  โ                                                    [Start Chatting] โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โ  โข Modal closes                                                          โ
โ  โข Claude Code is now selected in dropdown                               โ
โ  โข Claude Code process is spawned                                        โ
โ  โข User can start chatting                                               โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Flow 3: Authenticating with Codex (API Key)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ AUTH MODAL (API Key Style)                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Configure Codex                                                  [X] โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  โ                                                                      โโ
โ  โ  ๐ฎ Codex                                                            โโ
โ  โ                                                                      โโ
โ  โ  Enter your OpenAI API key to use Codex.                            โโ
โ  โ                                                                      โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ  โ API Key                                                         โโโ
โ  โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโโ
โ  โ  โ โ sk-...                                                  ๐๏ธ  โ โโโ
โ  โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโโ
โ  โ  โ                                                                 โโโ
โ  โ  โ ๐ Get your API key at platform.openai.com/api-keys            โโโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                                                                      โโ
โ  โ  โ Remember this key (stored securely)                              โโ
โ  โ                                                                      โโ
โ  โ                                                   [Cancel] [Save]   โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Flow 4: Managing AI Assistants in Settings

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Settings > AI Assistants                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Tabs: [Connection] [Appearance] [AI Models] [AI Assistants] [About] โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ DEFAULT ASSISTANT                                                    โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  โ                                                                      โโ
โ  โ  The default AI Assistant for new chat sessions.                    โโ
โ  โ                                                                      โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ  โ [๐ค OpenCode                                               โพ]  โโโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                                                                      โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ INSTALLED ASSISTANTS                                     [+ Custom] โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  โ                                                                      โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ  โ ๐ค OpenCode                                          DEFAULT  โ  โโ
โ  โ  โ Open-source AI coding assistant by SST                        โ  โโ
โ  โ  โ Status: โ Running                           [Stop] [Restart]  โ  โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ                                                                      โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ  โ ๐ง Claude Code                                    โ Signed in โ  โโ
โ  โ  โ Anthropic's Claude AI coding assistant                        โ  โโ
โ  โ  โ Status: โ Stopped                       [Start] [Sign out]    โ  โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ                                                                      โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ  โ ๐ Gemini CLI                                 ๐ Sign in      โ  โโ
โ  โ  โ Google's Gemini AI coding assistant                           โ  โโ
โ  โ  โ Status: โ Stopped                              [Sign in]      โ  โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ                                                                      โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ  โ ๐ฎ Codex                                      ๐ Add API key  โ  โโ
โ  โ  โ OpenAI's Codex coding assistant                               โ  โโ
โ  โ  โ Status: โ Stopped                            [Configure]      โ  โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ                                                                      โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ AVAILABLE ASSISTANTS                                                 โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  โ                                                                      โโ
โ  โ  Additional AI Assistants that can be installed.                    โโ
โ  โ                                                                      โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ  โ ๐ชฟ Goose                                                       โ  โโ
โ  โ  โ Block's open AI coding agent                        [Install] โ  โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ                                                                      โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ  โ ๐ Mistral Vibe                                                โ  โโ
โ  โ  โ Mistral AI coding assistant                         [Install] โ  โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ                                                                      โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Flow 5: Adding Custom AI Assistant

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Add Custom AI Assistant                                             [X] โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  Create a custom AI Assistant by specifying an ACP-compatible command.  โ
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ BASIC INFORMATION                                                    โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  โ                                                                      โโ
โ  โ  ID *                              Name *                            โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ  โ my-agent                    โ   โ My Custom Agent             โ  โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ                                                                      โโ
โ  โ  Description                                                         โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ  โ A custom agent for specialized tasks                            โโโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                                                                      โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ COMMAND CONFIGURATION                                                โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  โ                                                                      โโ
โ  โ  Command *                                                           โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ  โ npx                                                             โโโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                                                                      โโ
โ  โ  Arguments (one per line)                                            โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ  โ @my-org/my-agent                                                โโโ
โ  โ  โ --acp                                                           โโโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                                                                      โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ AUTHENTICATION (Optional)                                            โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  โ                                                                      โโ
โ  โ  โ This assistant requires authentication                           โโ
โ  โ                                                                      โโ
โ  โ  (When checked, additional fields appear)                           โโ
โ  โ  Auth Type: [API Key โพ]                                             โโ
โ  โ  Environment Variable: [MY_API_KEY]                                 โโ
โ  โ                                                                      โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ ENVIRONMENT VARIABLES (Optional)                                     โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  โ                                                                      โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโโโโ   [+ Add]   โโ
โ  โ  โ VAR_NAME            โ = โ value                   โ   [๐๏ธ]      โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโโโโ             โโ
โ  โ                                                                      โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โ                                            [Cancel] [Test] [Add Agent]  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Flow 6: Switching Agents During Chat

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Chat Interface with Agent Switching                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Sessions        โ  Chat: Build new feature                          โโ
โ  โ โโโโโโโโโโโโโโโ โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ โ ๐ Session 1โ โ  โ AI: [๐ค OpenCode โพ]   Mode: [Coder โพ]      โ  โโ
โ  โ โ   OpenCode  โ โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ โโโโโโโโโโโโโโโค โ                                                    โโ
โ  โ โ ๐ Session 2โ โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ โ   Claude    โ โ  โ User: Help me add authentication            โ  โโ
โ  โ โโโโโโโโโโโโโโโค โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ โ + New       โ โ                                                    โโ
โ  โ โโโโโโโโโโโโโโโ โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โ                 โ  โ Assistant: I'll help you add authentication โ  โโ
โ  โ                 โ  โ ...                                          โ  โโ
โ  โ                 โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                          โ
โ  BEHAVIOR:                                                               โ
โ  โข Each session shows which AI Assistant is being used                   โ
โ  โข Changing AI Assistant mid-session starts a NEW session                โ
โ  โข User is warned: "Switching will create a new session"                 โ
โ  โข Session list shows icon indicating which assistant                    โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## UI Components

### New Components to Create

| Component | Location | Purpose |
|-----------|----------|---------|
| `assistant-picker.svelte` | `lib/components/` | Dropdown for selecting AI Assistant |
| `mode-picker.svelte` | `lib/components/` | Dropdown for selecting Agent Mode |
| `assistant-card.svelte` | `lib/components/` | Card displaying assistant info & status |
| `assistant-auth-modal.svelte` | `lib/components/` | OAuth/API key authentication |
| `assistant-install-modal.svelte` | `lib/components/` | Installation progress |
| `custom-assistant-form.svelte` | `lib/components/` | Form for custom assistants |
| `assistants-settings.svelte` | `lib/components/` | Settings tab content |

### Component Specifications

#### assistant-picker.svelte

```svelte
<script lang="ts">
  import { Select } from '$lib/components/ui/select';
  import { assistants, selectedAssistantId } from '$lib/stores/assistants.svelte';
  
  interface Props {
    sessionId?: string;
    onSelect?: (assistantId: string) => void;
    disabled?: boolean;
  }
  
  let { sessionId, onSelect, disabled = false }: Props = $props();
  
  function handleSelect(id: string) {
    const assistant = assistants.list.find(a => a.id === id);
    if (assistant && !assistant.authenticated && assistant.config.requiresAuth) {
      // Open auth modal
      openAuthModal(id);
    } else {
      onSelect?.(id);
    }
  }
</script>

<Select.Root value={$selectedAssistantId} onValueChange={handleSelect} {disabled}>
  <Select.Trigger class="w-[200px]">
    <Select.Value placeholder="Select AI Assistant" />
  </Select.Trigger>
  <Select.Content>
    {#each assistants.list as assistant}
      <Select.Item value={assistant.id}>
        <span class="flex items-center gap-2">
          <span>{assistant.config.iconUrl ? '๐ค' : '๐ค'}</span>
          <span>{assistant.config.name}</span>
          {#if !assistant.authenticated && assistant.config.requiresAuth}
            <span class="text-muted-foreground">๐</span>
          {:else if assistant.status === 'running'}
            <span class="text-green-500">โ</span>
          {/if}
        </span>
      </Select.Item>
    {/each}
    <Select.Separator />
    <Select.Item value="__manage__">
      <span class="flex items-center gap-2">
        <span>โ๏ธ</span>
        <span>Manage AI Assistants...</span>
      </span>
    </Select.Item>
  </Select.Content>
</Select.Root>
```

#### assistant-auth-modal.svelte

```svelte
<script lang="ts">
  import { Dialog } from '$lib/components/ui/dialog';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  import { initAgentAuth, completeAgentAuth } from '$lib/stores/assistants.svelte';
  
  interface Props {
    assistantId: string;
    open: boolean;
    onOpenChange: (open: boolean) => void;
  }
  
  let { assistantId, open, onOpenChange }: Props = $props();
  
  let authState = $state<AgentAuthState | null>(null);
  let userInputCode = $state('');
  let isLoading = $state(false);
  let error = $state<string | null>(null);
  
  async function startAuth() {
    isLoading = true;
    error = null;
    try {
      authState = await initAgentAuth(assistantId);
    } catch (e) {
      error = (e as Error).message;
    } finally {
      isLoading = false;
    }
  }
  
  async function submitCode() {
    if (!userInputCode.trim()) return;
    isLoading = true;
    error = null;
    try {
      await completeAgentAuth(assistantId, { code: userInputCode });
      onOpenChange(false);
    } catch (e) {
      error = (e as Error).message;
    } finally {
      isLoading = false;
    }
  }
  
  $effect(() => {
    if (open && !authState) {
      startAuth();
    }
  });
</script>

<Dialog.Root {open} {onOpenChange}>
  <Dialog.Content>
    <Dialog.Header>
      <Dialog.Title>Sign in to {assistant.config.name}</Dialog.Title>
    </Dialog.Header>
    
    {#if authState?.flowType === 'url_first'}
      <!-- Claude Code style -->
      <div class="space-y-4">
        <p>Sign in with your {assistant.config.authProvider} account.</p>
        
        <div class="rounded-lg border p-4 space-y-3">
          <p class="font-medium">Step 1: Sign in</p>
          <Button onclick={() => window.open(authState.authUrl, '_blank')}>
            ๐ Sign in with {assistant.config.authProvider}
          </Button>
          
          <p class="font-medium">Step 2: Enter the code</p>
          <Input 
            bind:value={userInputCode}
            placeholder="Paste code from browser..."
          />
        </div>
        
        {#if error}
          <p class="text-destructive text-sm">{error}</p>
        {/if}
      </div>
      
      <Dialog.Footer>
        <Button variant="outline" onclick={() => onOpenChange(false)}>Cancel</Button>
        <Button onclick={submitCode} disabled={!userInputCode.trim() || isLoading}>
          {isLoading ? 'Verifying...' : 'Verify'}
        </Button>
      </Dialog.Footer>
      
    {:else if authState?.flowType === 'code_first'}
      <!-- GitHub Copilot style -->
      <div class="space-y-4">
        <p>Enter this code on the verification page:</p>
        
        <div class="rounded-lg border p-4 text-center">
          <p class="text-2xl font-mono font-bold">{authState.userCode}</p>
          <Button variant="ghost" size="sm">Copy</Button>
        </div>
        
        <Button onclick={() => window.open(authState.verificationUrl, '_blank')}>
          ๐ Open verification page
        </Button>
        
        <p class="text-sm text-muted-foreground">
          Waiting for authentication... โณ
        </p>
      </div>
      
    {:else if assistant.config.authType === 'api_key'}
      <!-- API Key style -->
      <div class="space-y-4">
        <p>Enter your API key:</p>
        
        <Input 
          type="password"
          bind:value={userInputCode}
          placeholder="sk-..."
        />
        
        <a href={assistant.config.authUrl} target="_blank" class="text-sm text-primary">
          ๐ Get your API key
        </a>
      </div>
      
      <Dialog.Footer>
        <Button variant="outline" onclick={() => onOpenChange(false)}>Cancel</Button>
        <Button onclick={submitCode} disabled={!userInputCode.trim() || isLoading}>
          Save
        </Button>
      </Dialog.Footer>
    {/if}
  </Dialog.Content>
</Dialog.Root>
```

---

## Backend Implementation

### Management API Changes

#### New Routes

```typescript
// apps/api/src/routes/agents.ts

import { Hono } from 'hono';
import { z } from 'zod';

const agentsRouter = new Hono();

// List all agents
agentsRouter.get('/', async (c) => {
  const gateway = getAcpGateway();
  const agents = await gateway.getAgents();
  const defaultId = await gateway.getDefaultAgentId();
  
  return c.json({
    assistants: agents,
    defaultAssistantId: defaultId,
  });
});

// Get agent details
agentsRouter.get('/:id', async (c) => {
  const { id } = c.req.param();
  const gateway = getAcpGateway();
  const agent = await gateway.getAgent(id);
  
  if (!agent) {
    return c.json({ error: 'Agent not found' }, 404);
  }
  
  return c.json(agent);
});

// Get agent modes
agentsRouter.get('/:id/modes', async (c) => {
  const { id } = c.req.param();
  const gateway = getAcpGateway();
  const modes = await gateway.getAgentModes(id);
  
  return c.json({ modes });
});

// Spawn agent
agentsRouter.post('/:id/spawn', async (c) => {
  const { id } = c.req.param();
  const body = await c.req.json();
  const gateway = getAcpGateway();
  
  const result = await gateway.spawnAgent(id, body.env, body.workingDirectory);
  
  return c.json(result);
});

// Stop agent
agentsRouter.post('/:id/stop', async (c) => {
  const { id } = c.req.param();
  const gateway = getAcpGateway();
  
  await gateway.stopAgent(id);
  
  return c.json({ success: true });
});

// Initialize auth
agentsRouter.post('/:id/auth', async (c) => {
  const { id } = c.req.param();
  const gateway = getAcpGateway();
  
  const result = await gateway.initAgentAuth(id);
  
  return c.json(result);
});

// Complete auth
agentsRouter.post('/:id/auth/complete', async (c) => {
  const { id } = c.req.param();
  const body = await c.req.json();
  const gateway = getAcpGateway();
  
  await gateway.completeAgentAuth(id, body);
  
  return c.json({ success: true });
});

// Add custom agent
agentsRouter.post('/custom', async (c) => {
  const body = await c.req.json();
  const gateway = getAcpGateway();
  
  const agent = await gateway.addCustomAgent(body);
  
  return c.json(agent);
});

// Remove agent
agentsRouter.delete('/:id', async (c) => {
  const { id } = c.req.param();
  const gateway = getAcpGateway();
  
  await gateway.removeAgent(id);
  
  return c.json({ success: true });
});

// Set default agent
agentsRouter.post('/default', async (c) => {
  const { agentId } = await c.req.json();
  const gateway = getAcpGateway();
  
  await gateway.setDefaultAgent(agentId);
  
  return c.json({ success: true });
});

export { agentsRouter };
```

### ACP Gateway Enhancements

#### Updated Agent Registry

```typescript
// docker/base/acp-gateway/src/agent-registry.ts

export const BUILTIN_AGENTS: AgentConfig[] = [
  {
    id: 'opencode',
    name: 'OpenCode',
    description: 'Open-source AI coding assistant by SST. Default agent with no authentication required.',
    command: 'opencode',
    args: ['acp'],
    requiresAuth: false,
    authType: 'none',
    isBuiltIn: true,
    isDefault: true,
  },
  {
    id: 'claude-code',
    name: 'Claude Code',
    description: 'Anthropic\'s Claude AI coding assistant. Requires Claude Pro/Max subscription.',
    command: 'claude-code-acp',
    args: [],
    requiresAuth: true,
    authType: 'device_flow',
    authFlowType: 'url_first',
    authProvider: 'anthropic',
    authUrl: 'https://console.anthropic.com/device',
    isBuiltIn: true,
    isDefault: false,
  },
  {
    id: 'gemini-cli',
    name: 'Gemini CLI',
    description: 'Google\'s Gemini AI coding assistant. Requires Google account.',
    command: 'gemini',
    args: ['--experimental-acp'],
    requiresAuth: true,
    authType: 'device_flow',
    authFlowType: 'code_first',
    authProvider: 'google',
    isBuiltIn: true,
    isDefault: false,
  },
  {
    id: 'codex',
    name: 'Codex',
    description: 'OpenAI\'s Codex coding assistant.',
    command: 'codex-acp',
    args: [],
    requiresAuth: true,
    authType: 'api_key',
    authProvider: 'openai',
    authUrl: 'https://platform.openai.com/api-keys',
    isBuiltIn: true,
    isDefault: false,
  },
];

export const AVAILABLE_AGENTS: AgentConfig[] = [
  {
    id: 'goose',
    name: 'Goose',
    description: 'Block\'s open AI coding agent.',
    command: 'goose',
    args: ['--acp'],
    requiresAuth: false,
    authType: 'none',
    isBuiltIn: false,
    isDefault: false,
  },
  {
    id: 'mistral-vibe',
    name: 'Mistral Vibe',
    description: 'Mistral AI coding assistant.',
    command: 'mistral-vibe',
    args: [],
    requiresAuth: true,
    authType: 'api_key',
    authProvider: 'mistral',
    isBuiltIn: false,
    isDefault: false,
  },
];
```

#### Enhanced Auth Handler

```typescript
// docker/base/acp-gateway/src/auth-handler.ts

export class AuthHandler {
  private authStates: Map<AgentId, AgentAuthState> = new Map();
  private tokens: Map<AgentId, { token: string; expiresAt: Date }> = new Map();

  /**
   * Initialize authentication for an agent.
   * Supports both url_first (Claude) and code_first (GitHub) flows.
   */
  async initializeAuth(agentId: AgentId): Promise<AgentAuthInitResponse> {
    const config = agentRegistry.getAgent(agentId);
    if (!config) {
      throw new Error(`Unknown agent: ${agentId}`);
    }

    if (config.authType === 'api_key') {
      return {
        flowType: 'api_key',
        message: `Enter your ${config.authProvider} API key`,
        authUrl: config.authUrl,
      };
    }

    if (config.authType === 'device_flow') {
      if (config.authFlowType === 'url_first') {
        // Claude Code style: generate auth URL, user brings back code
        const authUrl = await this.generateAuthUrl(agentId, config);
        
        const state: AgentAuthState = {
          agentId,
          status: 'pending',
          flowType: 'url_first',
          authUrl,
          expiresAt: new Date(Date.now() + 10 * 60 * 1000), // 10 min
        };
        this.authStates.set(agentId, state);
        
        return {
          flowType: 'url_first',
          authUrl,
          expiresIn: 600,
          message: 'Sign in and paste the code back here',
        };
        
      } else {
        // GitHub Copilot style: generate code, user enters on URL
        const { userCode, verificationUrl } = await this.generateDeviceCode(agentId, config);
        
        const state: AgentAuthState = {
          agentId,
          status: 'pending',
          flowType: 'code_first',
          userCode,
          verificationUrl,
          expiresAt: new Date(Date.now() + 10 * 60 * 1000),
        };
        this.authStates.set(agentId, state);
        
        // Start polling for completion
        this.pollForAuthCompletion(agentId);
        
        return {
          flowType: 'code_first',
          userCode,
          verificationUrl,
          expiresIn: 600,
          message: 'Enter this code on the verification page',
        };
      }
    }

    throw new Error(`Unsupported auth type: ${config.authType}`);
  }

  /**
   * Complete authentication with provided credentials.
   */
  async completeAuth(agentId: AgentId, request: AgentAuthCompleteRequest): Promise<void> {
    const config = agentRegistry.getAgent(agentId);
    if (!config) {
      throw new Error(`Unknown agent: ${agentId}`);
    }

    if (config.authType === 'api_key') {
      // Validate API key format
      if (!request.token) {
        throw new Error('API key is required');
      }
      this.setToken(agentId, request.token);
      return;
    }

    if (config.authFlowType === 'url_first') {
      // User provided code from browser
      if (!request.code) {
        throw new Error('Code is required');
      }
      
      const token = await this.exchangeCodeForToken(agentId, config, request.code);
      this.setToken(agentId, token);
      
      const state = this.authStates.get(agentId);
      if (state) {
        state.status = 'completed';
      }
      return;
    }

    // code_first flow completes automatically via polling
    throw new Error('Use polling for code_first flow');
  }

  private async generateAuthUrl(agentId: AgentId, config: AgentConfig): Promise<string> {
    // Implementation depends on provider
    // For Claude, this might involve starting the claude-code-acp process
    // and capturing its auth URL
    return config.authUrl || `https://auth.${config.authProvider}.com/device`;
  }

  private async generateDeviceCode(agentId: AgentId, config: AgentConfig): Promise<{
    userCode: string;
    verificationUrl: string;
  }> {
    // Generate device code via provider API
    // This is provider-specific
    return {
      userCode: 'ABCD-1234',
      verificationUrl: `https://auth.${config.authProvider}.com/device`,
    };
  }

  private async pollForAuthCompletion(agentId: AgentId): Promise<void> {
    // Poll provider API for auth completion
    // When complete, call setToken and update state
  }

  private async exchangeCodeForToken(
    agentId: AgentId, 
    config: AgentConfig, 
    code: string
  ): Promise<string> {
    // Exchange code for access token
    // Implementation is provider-specific
    return code; // Placeholder
  }

  setToken(agentId: AgentId, token: string, expiresIn?: number): void {
    const expiresAt = expiresIn 
      ? new Date(Date.now() + expiresIn * 1000)
      : new Date(Date.now() + 30 * 24 * 60 * 60 * 1000); // 30 days default
    
    this.tokens.set(agentId, { token, expiresAt });
  }

  getToken(agentId: AgentId): string | null {
    const entry = this.tokens.get(agentId);
    if (!entry) return null;
    if (entry.expiresAt < new Date()) {
      this.tokens.delete(agentId);
      return null;
    }
    return entry.token;
  }

  isAuthenticated(agentId: AgentId): boolean {
    return this.getToken(agentId) !== null;
  }

  getAuthStatus(agentId: AgentId): AuthStatusResponse {
    const token = this.tokens.get(agentId);
    return {
      authenticated: !!token && token.expiresAt > new Date(),
      expiresAt: token?.expiresAt.toISOString(),
    };
  }
}
```

---

## Frontend Implementation

### Store: assistants.svelte.ts

```typescript
// apps/frontend/src/lib/stores/assistants.svelte.ts

import { invoke } from '$lib/api/tauri';
import type { AgentInstance, AgentConfig, AgentAuthState, AgentMode } from '@agentpod/types';

// State
let assistants = $state<AgentInstance[]>([]);
let defaultAssistantId = $state<string>('opencode');
let modes = $state<Map<string, AgentMode[]>>(new Map());
let authStates = $state<Map<string, AgentAuthState>>(new Map());
let isLoading = $state(false);
let error = $state<string | null>(null);

// Derived
const installedAssistants = $derived(
  assistants.filter(a => a.config.isBuiltIn || a.status !== 'stopped')
);

const availableAssistants = $derived(
  assistants.filter(a => !a.config.isBuiltIn && a.status === 'stopped')
);

const defaultAssistant = $derived(
  assistants.find(a => a.id === defaultAssistantId)
);

// Exported store
export const assistantsStore = {
  get list() { return assistants; },
  get installed() { return installedAssistants; },
  get available() { return availableAssistants; },
  get defaultId() { return defaultAssistantId; },
  get default() { return defaultAssistant; },
  get isLoading() { return isLoading; },
  get error() { return error; },
  
  getModes(assistantId: string) {
    return modes.get(assistantId) || [];
  },
  
  getAuthState(assistantId: string) {
    return authStates.get(assistantId);
  },
};

// Actions
export async function fetchAssistants(): Promise<void> {
  isLoading = true;
  error = null;
  
  try {
    const response = await invoke<{ assistants: AgentInstance[]; defaultAssistantId: string }>(
      'list_agents'
    );
    assistants = response.assistants;
    defaultAssistantId = response.defaultAssistantId;
  } catch (e) {
    error = (e as Error).message;
    throw e;
  } finally {
    isLoading = false;
  }
}

export async function fetchModes(assistantId: string): Promise<AgentMode[]> {
  try {
    const response = await invoke<{ modes: AgentMode[] }>(
      'get_agent_modes',
      { agentId: assistantId }
    );
    modes.set(assistantId, response.modes);
    return response.modes;
  } catch (e) {
    console.error(`Failed to fetch modes for ${assistantId}:`, e);
    return [];
  }
}

export async function spawnAssistant(assistantId: string): Promise<void> {
  const assistant = assistants.find(a => a.id === assistantId);
  if (!assistant) throw new Error(`Unknown assistant: ${assistantId}`);
  
  if (assistant.config.requiresAuth && !assistant.authenticated) {
    throw new Error('Authentication required');
  }
  
  await invoke('spawn_agent', { agentId: assistantId });
  await fetchAssistants();
}

export async function stopAssistant(assistantId: string): Promise<void> {
  await invoke('stop_agent', { agentId: assistantId });
  await fetchAssistants();
}

export async function initAgentAuth(assistantId: string): Promise<AgentAuthState> {
  const response = await invoke<AgentAuthState>('init_agent_auth', { agentId: assistantId });
  authStates.set(assistantId, response);
  return response;
}

export async function completeAgentAuth(
  assistantId: string, 
  request: { code?: string; token?: string }
): Promise<void> {
  await invoke('complete_agent_auth', { agentId: assistantId, ...request });
  authStates.delete(assistantId);
  await fetchAssistants();
}

export async function setDefaultAssistant(assistantId: string): Promise<void> {
  await invoke('set_default_agent', { agentId: assistantId });
  defaultAssistantId = assistantId;
}

export async function addCustomAssistant(config: Partial<AgentConfig>): Promise<void> {
  await invoke('add_custom_agent', { config });
  await fetchAssistants();
}

export async function removeAssistant(assistantId: string): Promise<void> {
  await invoke('remove_agent', { agentId: assistantId });
  await fetchAssistants();
}
```

### Tauri Commands

```rust
// apps/frontend/src-tauri/src/commands/agents.rs

use tauri::State;
use crate::api::ApiClient;

#[tauri::command]
pub async fn list_agents(api: State<'_, ApiClient>) -> Result<serde_json::Value, String> {
    api.get("/api/agents")
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn get_agent(
    api: State<'_, ApiClient>,
    agent_id: String,
) -> Result<serde_json::Value, String> {
    api.get(&format!("/api/agents/{}", agent_id))
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn get_agent_modes(
    api: State<'_, ApiClient>,
    agent_id: String,
) -> Result<serde_json::Value, String> {
    api.get(&format!("/api/agents/{}/modes", agent_id))
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn spawn_agent(
    api: State<'_, ApiClient>,
    agent_id: String,
) -> Result<serde_json::Value, String> {
    api.post(&format!("/api/agents/{}/spawn", agent_id), &serde_json::json!({}))
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn stop_agent(
    api: State<'_, ApiClient>,
    agent_id: String,
) -> Result<serde_json::Value, String> {
    api.post(&format!("/api/agents/{}/stop", agent_id), &serde_json::json!({}))
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn init_agent_auth(
    api: State<'_, ApiClient>,
    agent_id: String,
) -> Result<serde_json::Value, String> {
    api.post(&format!("/api/agents/{}/auth", agent_id), &serde_json::json!({}))
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn complete_agent_auth(
    api: State<'_, ApiClient>,
    agent_id: String,
    code: Option<String>,
    token: Option<String>,
) -> Result<serde_json::Value, String> {
    api.post(
        &format!("/api/agents/{}/auth/complete", agent_id),
        &serde_json::json!({ "code": code, "token": token }),
    )
    .await
    .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn set_default_agent(
    api: State<'_, ApiClient>,
    agent_id: String,
) -> Result<serde_json::Value, String> {
    api.post("/api/agents/default", &serde_json::json!({ "agentId": agent_id }))
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn add_custom_agent(
    api: State<'_, ApiClient>,
    config: serde_json::Value,
) -> Result<serde_json::Value, String> {
    api.post("/api/agents/custom", &config)
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn remove_agent(
    api: State<'_, ApiClient>,
    agent_id: String,
) -> Result<serde_json::Value, String> {
    api.delete(&format!("/api/agents/{}", agent_id))
        .await
        .map_err(|e| e.to_string())
}
```

---

## Authentication Flows

### URL-First Flow (Claude Code Style)

```
โโโโโโโโโโโ          โโโโโโโโโโโ          โโโโโโโโโโโ          โโโโโโโโโโโ
โ Frontendโ          โ  Tauri  โ          โ   API   โ          โ Gateway โ
โโโโโโฌโโโโโ          โโโโโโฌโโโโโ          โโโโโโฌโโโโโ          โโโโโโฌโโโโโ
     โ                    โ                    โ                    โ
     โ initAgentAuth      โ                    โ                    โ
     โโโโโโโโโโโโโโโโโโโโโถโ                    โ                    โ
     โ                    โ POST /agents/:id/auth                   โ
     โ                    โโโโโโโโโโโโโโโโโโโโโถโ                    โ
     โ                    โ                    โ initializeAuth     โ
     โ                    โ                    โโโโโโโโโโโโโโโโโโโโโถโ
     โ                    โ                    โ                    โ
     โ                    โ                    โโโโโโโโโโโโโโโโโโโโโโ
     โ                    โโโโโโโโโโโโโโโโโโโโโโ { authUrl }        โ
     โโโโโโโโโโโโโโโโโโโโโโ                    โ                    โ
     โ { authUrl }        โ                    โ                    โ
     โ                    โ                    โ                    โ
     โ โโโ User opens authUrl in browser โโโโถ  โ                    โ
     โ โโโ User signs in, gets code โโโโโโโโโโถ โ                    โ
     โ                    โ                    โ                    โ
     โ completeAgentAuth(code)                 โ                    โ
     โโโโโโโโโโโโโโโโโโโโโถโ                    โ                    โ
     โ                    โ POST /agents/:id/auth/complete          โ
     โ                    โโโโโโโโโโโโโโโโโโโโโถโ                    โ
     โ                    โ                    โ completeAuth       โ
     โ                    โ                    โโโโโโโโโโโโโโโโโโโโโถโ
     โ                    โ                    โ                    โ
     โ                    โ                    โโโโโโโโโโโโโโโโโโโโโโ
     โ                    โโโโโโโโโโโโโโโโโโโโโโ success            โ
     โโโโโโโโโโโโโโโโโโโโโโ                    โ                    โ
     โ success            โ                    โ                    โ
     โ                    โ                    โ                    โ
```

### Code-First Flow (GitHub Copilot Style)

```
โโโโโโโโโโโ          โโโโโโโโโโโ          โโโโโโโโโโโ          โโโโโโโโโโโ
โ Frontendโ          โ  Tauri  โ          โ   API   โ          โ Gateway โ
โโโโโโฌโโโโโ          โโโโโโฌโโโโโ          โโโโโโฌโโโโโ          โโโโโโฌโโโโโ
     โ                    โ                    โ                    โ
     โ initAgentAuth      โ                    โ                    โ
     โโโโโโโโโโโโโโโโโโโโโถโ                    โ                    โ
     โ                    โ POST /agents/:id/auth                   โ
     โ                    โโโโโโโโโโโโโโโโโโโโโถโ                    โ
     โ                    โ                    โ initializeAuth     โ
     โ                    โ                    โโโโโโโโโโโโโโโโโโโโโถโ
     โ                    โ                    โ                    โ
     โ                    โ                    โโโโโโโโโโโโโโโโโโโโโโ
     โ                    โโโโโโโโโโโโโโโโโโโโโโ { userCode, url }  โ
     โโโโโโโโโโโโโโโโโโโโโโ                    โ                    โ
     โ { userCode, url }  โ                    โ                    โ
     โ                    โ                    โ                    โ
     โ โโโ Display code to user โโโโโโโโโโโโถ   โ                    โ
     โ โโโ User visits URL, enters code โโโโโถ  โ                    โ
     โ                    โ                    โ                    โ
     โ                    โ                    โ (Gateway polls)    โ
     โ                    โ                    โโโโโโโโโโโโโโโโโโโโโถโ
     โ                    โ                    โ                    โ
     โ โโโโ SSE: auth_complete โโโโโโโโโโโโโโโโโ                    โ
     โ                    โ                    โ                    โ
     โ fetchAssistants    โ                    โ                    โ
     โโโโโโโโโโโโโโโโโโโโโถโ                    โ                    โ
     โ                    โ                    โ                    โ
```

---

## Implementation Phases

### Phase 1: Core Infrastructure (Week 1)

**Goal:** Establish data models, API structure, and basic UI skeleton

#### Tasks

1. **Types Package**
   - [ ] Add agent types to `packages/types/src/agent.ts`
   - [ ] Export types from package

2. **ACP Gateway Updates**
   - [ ] Update `agent-registry.ts` with new agent configs
   - [ ] Update `auth-handler.ts` with flow type support
   - [ ] Add agent modes endpoint
   - [ ] Update types

3. **Management API**
   - [ ] Create `src/routes/agents.ts` with all endpoints
   - [ ] Add gateway proxy functionality
   - [ ] Register routes in main app

4. **Tauri Commands**
   - [ ] Create `src/commands/agents.rs`
   - [ ] Register commands in `main.rs`

5. **Frontend Store**
   - [ ] Create `lib/stores/assistants.svelte.ts`
   - [ ] Add basic fetch functionality

### Phase 2: Settings UI (Week 2)

**Goal:** Complete AI Assistants settings tab

#### Tasks

1. **Components**
   - [ ] Create `assistant-card.svelte`
   - [ ] Create `assistants-settings.svelte`
   - [ ] Create `custom-assistant-form.svelte`

2. **Settings Integration**
   - [ ] Add "AI Assistants" tab to settings page
   - [ ] Implement default assistant selector
   - [ ] Implement installed/available lists
   - [ ] Implement add custom assistant flow

3. **Testing**
   - [ ] Manual testing of settings flow
   - [ ] Test with mock data

### Phase 3: Authentication (Week 3)

**Goal:** Implement all authentication flows

#### Tasks

1. **Auth Modal**
   - [ ] Create `assistant-auth-modal.svelte`
   - [ ] Implement URL-first flow (Claude)
   - [ ] Implement code-first flow (GitHub)
   - [ ] Implement API key flow

2. **Gateway Auth**
   - [ ] Implement `generateAuthUrl` for each provider
   - [ ] Implement `generateDeviceCode` for each provider
   - [ ] Implement polling mechanism
   - [ ] Implement token storage

3. **Testing**
   - [ ] Test Claude Code auth flow
   - [ ] Test Codex API key flow
   - [ ] Test token persistence

### Phase 4: Chat Integration (Week 4)

**Goal:** Integrate assistant selection into chat

#### Tasks

1. **Components**
   - [ ] Create `assistant-picker.svelte`
   - [ ] Create `mode-picker.svelte`

2. **Chat UI Updates**
   - [ ] Add assistant picker to chat header
   - [ ] Add mode picker to chat header
   - [ ] Update session creation to include assistant selection
   - [ ] Handle switching assistants (create new session)

3. **Session List**
   - [ ] Show assistant icon per session
   - [ ] Filter sessions by assistant

4. **Testing**
   - [ ] Test session creation with different assistants
   - [ ] Test assistant switching behavior

### Phase 5: Container & Polish (Week 5)

**Goal:** Container integration and final polish

#### Tasks

1. **Container Updates**
   - [ ] Update Dockerfile to pre-install agents
   - [ ] Test agent binaries in container
   - [ ] Add on-demand installation support

2. **Polish**
   - [ ] Add loading states
   - [ ] Add error handling
   - [ ] Add tooltips and help text
   - [ ] Responsive design fixes

3. **Documentation**
   - [ ] Update user docs
   - [ ] Update API docs

---

## File Changes Summary

### New Files

```
packages/types/src/
โโโ agent.ts                              # Agent type definitions

apps/api/src/routes/
โโโ agents.ts                             # Agent API routes

apps/frontend/src-tauri/src/commands/
โโโ agents.rs                             # Tauri agent commands

apps/frontend/src/lib/
โโโ stores/
โ   โโโ assistants.svelte.ts              # Assistant state management
โโโ components/
    โโโ assistant-picker.svelte           # Assistant dropdown
    โโโ mode-picker.svelte                # Mode dropdown
    โโโ assistant-card.svelte             # Assistant info card
    โโโ assistant-auth-modal.svelte       # Auth dialog
    โโโ assistant-install-modal.svelte    # Install dialog
    โโโ custom-assistant-form.svelte      # Custom agent form
    โโโ assistants-settings.svelte        # Settings tab content
```

### Modified Files

```
packages/types/src/
โโโ index.ts                              # Export agent types

apps/api/src/
โโโ index.ts                              # Register agent routes

apps/frontend/src-tauri/src/
โโโ main.rs                               # Register agent commands
โโโ lib.rs                                # Module declaration

apps/frontend/src/
โโโ routes/
โ   โโโ settings/
โ   โ   โโโ +page.svelte                  # Add AI Assistants tab
โ   โโโ projects/[id]/chat/
โ       โโโ +page.svelte                  # Add assistant picker
โโโ lib/
    โโโ chat/
        โโโ RuntimeProvider.tsx           # Pass assistant to session

docker/base/
โโโ acp-gateway/src/
โ   โโโ agent-registry.ts                 # Updated agent configs
โ   โโโ auth-handler.ts                   # Enhanced auth flows
โ   โโโ types.ts                          # Updated types
โโโ Dockerfile                            # Install agent binaries
โโโ entrypoint.sh                         # Start ACP gateway
```

---

## Success Metrics

### Functional Requirements

- [ ] Users can view all available AI Assistants
- [ ] Users can authenticate with Claude Code (URL-first)
- [ ] Users can authenticate with Gemini CLI (code-first)
- [ ] Users can configure Codex with API key
- [ ] Users can add custom AI Assistants
- [ ] Users can select AI Assistant per session
- [ ] Users can select Agent Mode per session
- [ ] Users can set default AI Assistant
- [ ] OpenCode works without any authentication

### Non-Functional Requirements

- [ ] Auth tokens are stored securely (Tauri secure storage)
- [ ] Assistant switching doesn't lose session history
- [ ] UI is responsive on mobile
- [ ] Error states are handled gracefully
- [ ] Loading states are shown appropriately

---

*Document generated: December 2024*
*Last updated: December 2024*
