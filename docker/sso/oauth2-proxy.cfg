# =============================================================================
# AgentPod Central SSO - oauth2-proxy Configuration
# =============================================================================
# This is the central authentication service for all AgentPod containers.
# It handles OAuth2 flow with Keycloak and sets session cookies that are
# shared across all *.superchotu.com subdomains.
#
# Environment variables required:
#   OAUTH2_PROXY_CLIENT_SECRET  - Keycloak client secret for agentpod-container
#   OAUTH2_PROXY_COOKIE_SECRET  - 32-byte secret for cookie encryption
# =============================================================================

# -----------------------------------------------------------------------------
# Server Configuration
# -----------------------------------------------------------------------------
http_address = "0.0.0.0:4180"

# Static upstream - we don't proxy to any backend, just handle auth
# Returns 202 for authenticated requests, 401 for unauthenticated
upstreams = ["static://202"]

# We're behind a reverse proxy (Coolify/Traefik)
reverse_proxy = true

# -----------------------------------------------------------------------------
# Keycloak OIDC Provider
# -----------------------------------------------------------------------------
provider = "keycloak-oidc"
provider_display_name = "AgentPod"

# Client credentials
# client_secret is set via OAUTH2_PROXY_CLIENT_SECRET environment variable
client_id = "agentpod-container"

# Keycloak realm URL
oidc_issuer_url = "https://auth.superchotu.com/realms/agentpod"

# PKCE for enhanced security
code_challenge_method = "S256"

# Allow all email domains (Keycloak handles authorization)
email_domains = ["*"]

# -----------------------------------------------------------------------------
# Cookie Configuration - CRITICAL for cross-subdomain SSO
# -----------------------------------------------------------------------------
cookie_name = "_agentpod_session"

# Share cookies across ALL *.superchotu.com subdomains
# This enables single sign-on across all containers
cookie_domains = [".superchotu.com"]

cookie_secure = true
cookie_httponly = true
cookie_samesite = "lax"

# Session duration
cookie_expire = "168h"    # 7 days
cookie_refresh = "1h"     # Refresh token every hour

# cookie_secret is set via OAUTH2_PROXY_COOKIE_SECRET environment variable
# Must be exactly 16, 24, or 32 bytes

# -----------------------------------------------------------------------------
# Redirect & Whitelist
# -----------------------------------------------------------------------------
# Allow redirects to any *.superchotu.com subdomain
whitelist_domains = [".superchotu.com"]

# -----------------------------------------------------------------------------
# Auth Behavior
# -----------------------------------------------------------------------------
# Skip authentication for health check endpoints
skip_auth_routes = [
    "GET=^/ping$",
    "GET=^/health$"
]

# -----------------------------------------------------------------------------
# Headers & Token Passing
# -----------------------------------------------------------------------------
# Pass auth info to upstream services via headers
set_xauthrequest = true
pass_access_token = true
pass_authorization_header = true

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
standard_logging = true
request_logging = true
auth_logging = true
logging_local_time = true

# -----------------------------------------------------------------------------
# Security
# -----------------------------------------------------------------------------
# SSL/TLS verification for OIDC provider
ssl_insecure_skip_verify = false
