# =============================================================================
# oauth2-proxy Configuration for AgentPod Containers
# =============================================================================
# Provides Keycloak SSO authentication for container services.
# Uses nginx auth_request mode for integration.
# =============================================================================

# -----------------------------------------------------------------------------
# Server Configuration
# -----------------------------------------------------------------------------
http_address = "0.0.0.0:4180"
reverse_proxy = true

# For nginx auth_request mode - return 202/401 status codes
upstreams = ["static://202"]

# -----------------------------------------------------------------------------
# Keycloak OIDC Provider
# -----------------------------------------------------------------------------
provider = "keycloak-oidc"
provider_display_name = "AgentPod"

# Client credentials - these should be set via environment variables:
# OAUTH2_PROXY_CLIENT_ID
# OAUTH2_PROXY_CLIENT_SECRET
client_id = "agentpod-container"

# Keycloak realm URL
oidc_issuer_url = "https://auth.superchotu.com/realms/agentpod"

# Allow all email domains (Keycloak handles authorization)
email_domains = ["*"]

# PKCE for enhanced security (required by our Keycloak client config)
code_challenge_method = "S256"

# -----------------------------------------------------------------------------
# Cookie Configuration - CRITICAL for session sharing
# -----------------------------------------------------------------------------
cookie_name = "_agentpod_session"
cookie_secure = true
cookie_httponly = true
cookie_samesite = "lax"

# Share cookies across all *.superchotu.com subdomains
# This enables SSO across different project containers
cookie_domains = [".superchotu.com"]

# Session duration
cookie_expire = "168h"    # 7 days
cookie_refresh = "1h"     # Refresh token every hour

# Cookie secret - MUST be set via environment variable:
# OAUTH2_PROXY_COOKIE_SECRET (32-byte base64 encoded)

# -----------------------------------------------------------------------------
# Redirect & Whitelist
# -----------------------------------------------------------------------------
# Allow redirects to any *.superchotu.com subdomain
whitelist_domains = [".superchotu.com"]

# Redirect URL after login (defaults to original request)
# redirect_url is auto-generated based on request

# -----------------------------------------------------------------------------
# Auth Behavior
# -----------------------------------------------------------------------------
# Skip authentication for these routes (regex patterns)
skip_auth_routes = [
    "GET=^/health$",
    "GET=^/favicon.ico$"
]

# For API routes, return 401 instead of redirect to login page
# This allows programmatic clients to handle auth properly
api_routes = [
    "^/opencode/",
    "^/acp/"
]

# -----------------------------------------------------------------------------
# Headers & Token Passing
# -----------------------------------------------------------------------------
# Pass auth info to upstream services via headers
set_xauthrequest = true
pass_access_token = true
pass_authorization_header = true

# Header names (defaults)
# X-Auth-Request-User
# X-Auth-Request-Email
# X-Auth-Request-Access-Token
# Authorization: Bearer <token>

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
logging_filename = ""
standard_logging = true
request_logging = true
auth_logging = true

# Log format
logging_local_time = true

# -----------------------------------------------------------------------------
# Security
# -----------------------------------------------------------------------------
# SSL/TLS verification for OIDC provider
ssl_insecure_skip_verify = false

# Request signing (optional, for additional security)
# signature_key = ""

# -----------------------------------------------------------------------------
# Session Storage (optional - defaults to cookie)
# -----------------------------------------------------------------------------
# For production with many users, consider Redis:
# session_store_type = "redis"
# redis_connection_url = "redis://redis:6379"

# -----------------------------------------------------------------------------
# Custom Templates (optional)
# -----------------------------------------------------------------------------
# custom_templates_dir = "/opt/oauth2-proxy/templates"

# -----------------------------------------------------------------------------
# Rate Limiting (optional)
# -----------------------------------------------------------------------------
# rate_limit = 0  # Disabled by default
